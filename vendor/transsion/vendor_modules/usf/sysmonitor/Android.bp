// Android.bp — vendor/transsion/vendor_modules/usf/sysmonitor/
//
// Targets:
//   libsysmonitor                    vendor .so  (core + collectors)
//   libsysmonitor_jni                system_ext .so  (JNI bridge)
//   vendor.transsion.sysmonitor-service  vendor daemon
//   sysmonitor_tests                 device unit tests
//
// Part 6 changes vs Part 1 draft:
//   • srcs paths updated: vendor/core/, vendor/collector/, vendor/dispatch/,
//     vendor/platform/, vendor/service/ (all Part 1-4 deliverable locations)
//   • system JNI src path: system/native/jni/
//   • JavaBridgeSetInstance.cpp added to libsysmonitor
//   • AIDL deps added to libsysmonitor / libsysmonitor_jni
//   • android.sharedmem added to jni shared_libs
//   • java_library for system Java collectors

// ---------------------------------------------------------------------------
// Soong config: platform selection
// ---------------------------------------------------------------------------
soong_config_module_type {
    name: "sysmonitor_cc_defaults",
    module_type: "cc_defaults",
    config_namespace: "transsion_sysmonitor",
    variables: ["platform"],
    properties: ["cflags"],
}

soong_config_string_variable {
    name: "platform",
    values: ["qcom", "mtk", "unisoc"],
}

sysmonitor_cc_defaults {
    name: "sysmonitor_platform_defaults",
    soong_config_variables: {
        platform: {
            qcom:   { cflags: ["-DSMON_PLATFORM_QCOM"]   },
            mtk:    { cflags: ["-DSMON_PLATFORM_MTK"]    },
            unisoc: { cflags: ["-DSMON_PLATFORM_UNISOC"] },
        },
    },
}

// ---------------------------------------------------------------------------
// Common C++ defaults
// ---------------------------------------------------------------------------
cc_defaults {
    name: "sysmonitor_cc_base",
    defaults: ["sysmonitor_platform_defaults"],

    cflags: [
        "-Wall",
        "-Wextra",
        "-Werror",
        "-O2",
        "-fno-exceptions",
        "-fno-rtti",
        // Uncomment for production (strips all log strings):
        // "-DSMON_LOG_DISABLED",
    ],

    target: {
        android: { cflags: ["-DANDROID"] },
    },
}



// ---------------------------------------------------------------------------
// libsysmonitor_jni — JNI bridge (system_ext partition)
//   Loaded by SysMonitorBridge.java inside the system Java process.
//   Reads MetricStore via ashmem (zero-copy); pushes Java metrics via AIDL.
// ---------------------------------------------------------------------------
cc_library_shared {
    name: "libsysmonitor_jni",
    system_ext_specific: true,

    cflags: [
        "-Wall",
        "-Wextra",
        "-Werror",
        "-O2",
        "-fno-exceptions",
        "-fno-rtti",
    ],

    srcs: [
        "system/native/jni/SysMonitorJNI.cpp",
    ],

    local_include_dirs: [
        "vendor/core/include",       // MetricStore.h, MetricDef.h
        "vendor/platform/include",   // SysMonLog.h (optional)
    ],

    shared_libs: [
        "liblog",
        "libcutils",
        "libbase",
        "libnativehelper",
        "libandroid_runtime",
        "libandroid",                // ASharedMemory_*
        "libbinder_ndk",
        // AIDL NDK backend (for ISysMonitor client calls)
        "vendor.transsion.hardware.sysmonitor-V1-ndk",
    ],
}





// ---------------------------------------------------------------------------
// Unit tests
// ---------------------------------------------------------------------------
cc_test {
    name: "sysmonitor_tests",
    defaults: ["sysmonitor_cc_base"],
    vendor: true,
    test_suites: ["device-tests"],

    srcs: [
        "tests/MetricStoreTest.cpp",
        "tests/CpuCollectorTest.cpp",
        "tests/NodeProbeTest.cpp",
    ],

    local_include_dirs: [
        "vendor/core/include",
        "vendor/platform/include",
    ],

    shared_libs: [
        "libsysmonitor",
        "liblog",
        "libbase",
    ],

    static_libs: [
        "libgtest",
        "libgmock",
    ],
}
